{
    "collab_server" : "",
    "contents" : "rm(list =ls())\nsource(\"code/lib.R\")\nreadme <- readLines(\"data/barrolee/readme.txt\")[-c(1:716)]\nfirstlines <- which(grepl(\".prn\",readme))\ncountries <- readLines(\"data/barrolee/readme.txt\")[c(565:702)] %>%\n  gsub(pattern = \" {2,}\", replacement = \"  \", x = .) %>%\n  gsub(pattern = \"^ \", replacement = \"\", x = .) %>%\n  strsplit(split = \"  \") %>%\n  do.call(what =rbind, args = .) %>%\n  as.data.frame() %>%\n  set_names(c(\"SHCODE\", \"COUNTRY  NAME\", \"WBCTRY\", \"SMPL98\", \"SMPL97\"))\nget.names.BL <- function(x, i) {\n  if(!is.na(firstlines[i+1])) {\n    data.frame(File = word(readme[x]),\n               Colname = (c(readme[x:(firstlines[i+1]-1)]) %>%\n      paste(collapse = \" \") %>%\n       gsub(pattern = \".{1,}: {1,}\", replacement = \"\", x = .) %>%\n       gsub(pattern = \" {2,}\", replacement = \" \", x = .) %>%\n       gsub(pattern = \"^ | $\", replacement = \"\", x = .) %>%\n      strsplit(split = \" \") %>%\n        unlist\n      )\n    )\n  } else {\n    data.frame(File = word(readme[x]),\n               Colname = (c(readme[x:length(readme)]) %>%\n                             paste(collapse = \" \") %>%\n                             gsub(pattern = \".{1,}: {1,}\", replacement = \"\", x = .) %>%\n                             gsub(pattern = \" {2,}\", replacement = \" \", x = .) %>%\n                             gsub(pattern = \"^ | $\", replacement = \"\", x = .) %>%\n                             strsplit(split = \" \") %>%\n                             unlist\n               )\n    )\n  }\n}\nset.seed(1)\nfile_colname <- imap_dfr(firstlines, get.names.BL) \n\nset.names.BL <- function(x){\n    read.table(paste0(\"data/barrolee/\",x$File[1])) %>%\n      purrr::set_names(x$Colname)\n}\n\ndf <- file_colname %>%\n  split(.$File) %>%\n  map_dfc(set.names.BL) %>% \n  mutate(WBCTRY = as.character(countries$WBCTRY)) #%>%\n# t()\ndf_list <- list()\ndf_list[[1]] <- df %>%\n  select(matches(\"[a-z][0-9]{1}$|grsh5|invsh5|invsh4|\n                    grsh4|govsh4|govsh5|gvxdxe4|gvxdxe5\"),\n        -durs1)\ndf_list[[2]] <- df %>%\n  select(matches(\"[a-z][0-9]{2}$|gdpsh5|gdpsh4|pop15|pop65|lifee0|pysh5|pcsh5|pish5|pgsh5\"),\n         -c(matches(\"grsh5|invsh5|invsh4|\n                    grsh4|govsh4|govsh5|gvxdxe4|gvxdxe5|smpl97\")\n      ))\ndf_list[[3]] <- df %>%\n  select(matches(\"bmp[0-9]l|bmp2ml\"))\ndf_list[[4]] <- df %>%\n  select(names(df)[which(!names(df) %in% c(names(dfy), names(dfyy), names(dfyl)))])\n# с одной цифрой или просто плохие\n# INVWBx GRWBx INVSH5x GRSH5x \n# INVSH4x GRSH4x \n# POP15xx\n# GOVSH4x GOVSH5x GDEx GEERECx GEETOTx\n# INVPUBx GGCFDx GVXDXE4x GVXDXE5x PINSTABx ASSASSPx\n# COUPx REVOLx PINSTABx POLRIGHTx CIVLIBx EXx\n# IMx BMPx TOTx LLYx\n\n# SMPL97 DURS1\n\n# GDPSH4xx GDPSH5xx POP65xx\n\n# Type xx for date indicators, x for averagee period indicators, con for constant\n\ncut.colname.BL <- function(df, i) {\n  if(i == 3) {\n    data.frame(Colname = colnames(df)) %>%\n      inner_join(file_colname, by = \"Colname\") %>%\n      mutate(Colname_cut = \"bmpl\",\n             Type = \"x\") %>%\n      return()\n  } else {if(i == 4) {\n    i <- 0\n  }\n  data.frame(Colname = colnames(df)) %>%\n    inner_join(file_colname, by = \"Colname\") %>%\n    mutate(Colname_cut = substr(Colname, 1,nchar(Colname)-i),\n           Type = ifelse(i == 2, \"xx\",\n                          ifelse(i == 1,\n                                  \"x\",\n                                  \"con\"))) %>%\n    unique() %>%\n    return()\n  }\n}\ncut_colname_type <- imap_dfr(df_list, cut.colname.BL)  \nmap(cut_colname_type %>% pull(Colname_cut) %>% unique, melt.BL, df)\nmelt.BL <- function(cn, df) {\n  df %>%\n    select(matches(paste0(\"^\", cn, \"[0-9]{2}$\")), WBCTRY) %>%\n    as.data.table() %>%\n    melt.data.table(id.vars = \"WBCTRY\",\n                    variable.name = \"Indicator\",\n                    value.name = \"Value\") %T>%\n    mutate(Year = paste0(\"19\",\n                         substring(Indicator,\n                                   nchar(Indicator)-1)),\n           Indicator = substr(Indicator, 1, nchar(Indicator)-2))\n}\n# train <- df_colnames %>% sample_n(3)\n# \n  \n    \nread.table(paste0(\"data/barrolee/\",\"codes.prn\"))\n",
    "created" : 1542906286674.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "619906548",
    "id" : "988DF861",
    "lastKnownWriteTime" : 1542925854,
    "last_content_update" : 1542925854721,
    "path" : "C:/mkhlgrv/hds_macro/code/importbarrolee.R",
    "project_path" : "code/importbarrolee.R",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}